<!doctype html><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>0050 波動預測（真實資料）</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:960px;margin:20px auto;padding:0 14px;line-height:1.6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,button{font-size:16px;padding:8px;margin:4px 0;width:100%}
.card{border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0}
canvas{width:100%;height:220px;border:1px solid #eee;border-radius:8px}
small{color:#666}
</style>
<h1>0050 波動預測（真實 1m 資料）</h1>
<p><small>資料來源：Yahoo Finance 1 分鐘（近 7 天）。教育用途。</small></p>

<div class='card'>
  <div class='row'>
    <label>視窗大小（N）<input id='n' type='number' value='60'></label>
    <label>輸出點數<input id='w' type='number' value='300'></label>
  </div>
  <button id='run'>重新計算</button>
</div>

<div class='card'>
  <h3>滾動波動（std of log returns）</h3>
  <canvas id='chart' width='900' height='240'></canvas>
  <p id='summary'></p>
</div>

<script>
async function load(){
  const res = await fetch('../0050-live/data.json?ts=' + Date.now());
  if(!res.ok){ return null; }
  const payload = await res.json();
  return payload.data || [];
}

function draw(series){
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const w=c.width,h=c.height,pad=10;
  const min=Math.min(...series), max=Math.max(...series);
  ctx.beginPath();
  series.forEach((v,i)=>{
    const x=pad + (w-2*pad)*(i/(series.length-1));
    const y=h-pad - (h-2*pad)*((v-min)/(max-min||1));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#36c'; ctx.lineWidth=2; ctx.stroke();
}

function std(arr){
  const m=arr.reduce((a,b)=>a+b,0)/arr.length;
  const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
  return Math.sqrt(v);
}

async function run(){
  const data = await load();
  if(!data || !data.length){
    document.getElementById('summary').textContent='尚無資料'; return;
  }
  const N = Math.max(5, +document.getElementById('n').value||60);
  const W = Math.max(50, +document.getElementById('w').value||300);
  const prices = data.map(d=>d.c).slice(-W-N-1);
  const rets = prices.slice(1).map((v,i)=>Math.log(v/prices[i]));
  const vol = [];
  for(let i=N-1;i<rets.length;i++){
    vol.push(std(rets.slice(i-N+1,i+1)));
  }
  draw(vol);
  const last = vol[vol.length-1];
  document.getElementById('summary').textContent = `最新波動（std）：${last.toFixed(5)}｜樣本點數：${vol.length}`;
}

document.getElementById('run').onclick=run;
run();
</script>
