<!doctype html><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>0050 回測模擬（真實資料）</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:960px;margin:20px auto;padding:0 14px;line-height:1.6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,select,button{font-size:16px;padding:8px;margin:4px 0;width:100%}
.card{border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0}
canvas{width:100%;height:240px;border:1px solid #eee;border-radius:8px}
small{color:#666}
</style>
<h1>0050 回測模擬（真實 1m 資料）</h1>
<p><small>資料來源：Yahoo Finance 1 分鐘（近 7 天）。本頁僅教育用途。</small></p>
<p><small id='ver'>版本：載入中…</small></p>

<div class='card'>
  <div class='row'>
    <label>初始資金（元）<input id='cash' type='number' value='100000'></label>
    <label>每 30 分鐘投入（元）<input id='dca' type='number' value='1000'></label>
  </div>
  <div class='row'>
    <label>手續費（%）<input id='fee' type='number' value='0.1'></label>
    <label>滑價（%）<input id='slip' type='number' value='0.05'></label>
  </div>
  <div class='row'>
    <label>策略<select id='strategy'>
      <option value='dca' selected>定期定額（每 30 分鐘）</option>
      <option value='lump'>一次買入</option>
      <option value='hold'>只持有現金</option>
      <option value='ma'>策略：短長均線交叉（20/60）</option>
      <option value='mom'>策略：動能（30）</option>
      <option value='mr'>策略：均值回歸（60, kσ）</option>
      <option value='force'>測試：強制買入（首筆）</option>
    </select></label>
    <label>回測視窗（最後 N 筆）<input id='window' type='number' value='300'></label>
  </div>
  <div class='row'>
    <label>均值回歸門檻 k（σ）<input id='mrk' type='number' value='0.3' step='0.1'></label>
    <label>動能視窗（N）<input id='momk' type='number' value='30'></label>
  </div>
  <button id='run'>開始回測</button>
</div>

<div class='card'>
  <h3>資產曲線</h3>
  <canvas id='chart' width='900' height='260'></canvas>
  <p id='summary'></p>
  <ul id='metrics'></ul>
</div>

<div class='card'>
  <h3>交易紀錄（前 20 筆）</h3>
  <ol id='tx'></ol>
</div>

<script>
async function load(){
  try{
    const res = await fetch('../0050-live/data.json?ts=' + Date.now());
    if(!res.ok){ return {data:[], error:`fetch failed: ${res.status}`}; }
    const payload = await res.json();
    return {data: payload.data || [], error: null};
  }catch(e){
    return {data:[], error: e?.message || 'fetch error'};
  }
}

function demoData(n=300){
  let p=70; const out=[];
  for(let i=0;i<n;i++){
    p = Math.max(1, p + (Math.random()-0.48)*0.3);
    out.push({c: p});
  }
  return out;
}

function draw(series){
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const w=c.width,h=c.height,pad=10;
  const min=Math.min(...series), max=Math.max(...series);
  ctx.beginPath();
  series.forEach((v,i)=>{
    const x=pad + (w-2*pad)*(i/(series.length-1));
    const y=h-pad - (h-2*pad)*((v-min)/(max-min||1));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#2b7'; ctx.lineWidth=2; ctx.stroke();
}

function maxDrawdown(series){
  let peak=series[0], maxdd=0;
  for(const v of series){
    peak=Math.max(peak,v);
    maxdd=Math.min(maxdd, (v-peak)/peak);
  }
  return maxdd;
}

function volatility(returns){
  if(returns.length<2) return 0;
  const m=returns.reduce((a,b)=>a+b,0)/returns.length;
  const v=returns.reduce((a,b)=>a+(b-m)*(b-m),0)/returns.length;
  return Math.sqrt(v);
}

async function run(){
  const {data, error} = await load();
  let usedDemo=false;
  let src=data;
  if(!src || !src.length){
    src = demoData(320);
    usedDemo=true;
  }
  const windowN = Math.max(50, +document.getElementById('window').value||300);
  const series = src.slice(-windowN).map(d=>d.c);
  const cash0 = +document.getElementById('cash').value || 100000;
  const dca = +document.getElementById('dca').value || 1000;
  const fee = (+document.getElementById('fee').value || 0)/100;
  const slip = (+document.getElementById('slip').value || 0)/100;
  const strategy = document.getElementById('strategy').value;
  const mrk = +document.getElementById('mrk').value || 0.3;
  const momk = +document.getElementById('momk').value || 30;

  function sma(arr, i, n){
    if(i+1<n) return null;
    let s=0; for(let k=i-n+1;k<=i;k++) s+=arr[k];
    return s/n;
  }
  function std(arr, i, n){
    if(i+1<n) return null;
    let s=0; for(let k=i-n+1;k<=i;k++) s+=arr[k];
    const m=s/n; let v=0; for(let k=i-n+1;k<=i;k++) v+=(arr[k]-m)*(arr[k]-m);
    return Math.sqrt(v/n);
  }

  let cash=cash0, shares=0; const equity=[]; const tx=[]; let invested=cash0;
  series.forEach((price,i)=>{
    let buy = 0;
    let sell = 0;

    if(strategy==='lump' && i===0) buy = cash;
    if(strategy==='dca' && i%30===0) buy = dca; // every 30 mins
    if(strategy==='force' && i===0) buy = (dca>0?dca:cash);

    if(strategy==='ma'){
      const s = sma(series,i,20);
      const l = sma(series,i,60);
      if(s && l){
        const target = s>l ? 1 : 0;
        if(target===1 && shares===0) buy = cash;
        if(target===0 && shares>0) sell = shares;
      }
    }
    if(strategy==='mom'){
      const look=momk;
      if(i>=look){
        const target = price>series[i-look] ? 1 : 0;
        if(target===1 && shares===0) buy = cash;
        if(target===0 && shares>0) sell = shares;
      }
    }
    if(strategy==='mr'){
      const m = sma(series,i,60);
      const s = std(series,i,60);
      if(m && s){
        if(price < (m-mrk*s) && shares===0) buy = cash;
        if(price > (m+mrk*s) && shares>0) sell = shares;
      }
    }

    if(buy>0){
      let cost = buy*(1+fee+slip);
      if(strategy==='force' && i===0 && cash<cost){
        buy = cash/(1+fee+slip);
        cost = buy*(1+fee+slip);
      }
      if(cash>=cost){
        const qty = buy/price;
        shares += qty; cash -= cost; invested += buy;
        tx.push(`第${i+1}分鐘：買入 ${qty.toFixed(3)} 股 @ ${price.toFixed(2)}，費用 ${(cost-buy).toFixed(0)}`);
      }else if(strategy==='force' && i===0){
        tx.push(`DEBUG：force 買入失敗 cash=${cash.toFixed(2)} cost=${cost.toFixed(2)}`);
      }
    }
    if(sell>0){
      const proceeds = sell*price*(1-fee-slip);
      cash += proceeds; shares -= sell;
      tx.push(`第${i+1}分鐘：賣出 ${sell.toFixed(3)} 股 @ ${price.toFixed(2)}，費用 ${(sell*price - proceeds).toFixed(0)}`);
    }

    equity.push(cash + shares*price);
  });

  draw(equity);
  const total = equity[equity.length-1];
  const rets = equity.slice(1).map((v,i)=>Math.log(v/equity[i]));
  const vol = volatility(rets);
  const mdd = maxDrawdown(equity);

  const note = usedDemo ? '（示範資料）' : '';
  const errNote = error ? `｜資料讀取失敗：${error}` : '';
  document.getElementById('summary').textContent = `期末資產 ${Math.round(total).toLocaleString()} 元（投入 ${Math.round(invested).toLocaleString()} 元）${note}${errNote}`;
  const tradeNote = tx.length===0 ? '<li>本次策略未觸發交易，試試改策略或放大回測視窗。</li>' : '';
  const minP=Math.min(...series), maxP=Math.max(...series);
  document.getElementById('metrics').innerHTML = `
    <li>最大回撤：${(mdd*100).toFixed(2)}%</li>
    <li>波動（log return std）：${vol.toFixed(4)}</li>
    <li>樣本點數：${series.length}</li>
    <li>價格區間：${minP.toFixed(2)} ~ ${maxP.toFixed(2)}</li>
    <li>交易筆數：${tx.length}</li>
    <li>debug：strategy=${strategy}｜cash=${cash0}｜dca=${dca}｜fee=${fee}｜slip=${slip}｜mrk=${mrk}｜momk=${momk}｜p0=${series[0]?.toFixed?.(2)}｜p1=${series[1]?.toFixed?.(2)}</li>
    ${tradeNote}`;
  document.getElementById('tx').innerHTML = tx.slice(0,20).map(t=>`<li>${t}</li>`).join('') || '<li>（無交易紀錄）</li>';
}

document.getElementById('run').onclick=run;
['strategy','window','cash','dca','fee','slip','mrk','momk'].forEach(id=>{
  document.getElementById(id).addEventListener('change', run);
});
const ver = new Date().toISOString().replace('T',' ').slice(0,19);
document.getElementById('ver').textContent = `版本：${ver}`;
run();
</script>
