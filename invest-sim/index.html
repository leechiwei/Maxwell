<!doctype html><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>0050 回測模擬（真實資料）</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:960px;margin:20px auto;padding:0 14px;line-height:1.6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,select,button{font-size:16px;padding:8px;margin:4px 0;width:100%}
.card{border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0}
canvas{width:100%;height:240px;border:1px solid #eee;border-radius:8px}
small{color:#666}
</style>
<h1>0050 回測模擬（真實 1m 資料）</h1>
<p><small>資料來源：Yahoo Finance 1 分鐘（近 7 天）。本頁僅教育用途。</small></p>

<div class='card'>
  <div class='row'>
    <label>初始資金（元）<input id='cash' type='number' value='100000'></label>
    <label>每 30 分鐘投入（元）<input id='dca' type='number' value='1000'></label>
  </div>
  <div class='row'>
    <label>手續費（%）<input id='fee' type='number' value='0.1'></label>
    <label>滑價（%）<input id='slip' type='number' value='0.05'></label>
  </div>
  <div class='row'>
    <label>策略<select id='strategy'>
      <option value='dca'>定期定額（每 30 分鐘）</option>
      <option value='lump'>一次買入</option>
      <option value='hold'>只持有現金</option>
    </select></label>
    <label>回測視窗（最後 N 筆）<input id='window' type='number' value='300'></label>
  </div>
  <button id='run'>開始回測</button>
</div>

<div class='card'>
  <h3>資產曲線</h3>
  <canvas id='chart' width='900' height='260'></canvas>
  <p id='summary'></p>
  <ul id='metrics'></ul>
</div>

<div class='card'>
  <h3>交易紀錄（前 20 筆）</h3>
  <ol id='tx'></ol>
</div>

<script>
async function load(){
  const res = await fetch('../0050-live/data.json?ts=' + Date.now());
  if(!res.ok){ return null; }
  const payload = await res.json();
  return payload.data || [];
}

function draw(series){
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const w=c.width,h=c.height,pad=10;
  const min=Math.min(...series), max=Math.max(...series);
  ctx.beginPath();
  series.forEach((v,i)=>{
    const x=pad + (w-2*pad)*(i/(series.length-1));
    const y=h-pad - (h-2*pad)*((v-min)/(max-min||1));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#2b7'; ctx.lineWidth=2; ctx.stroke();
}

function maxDrawdown(series){
  let peak=series[0], maxdd=0;
  for(const v of series){
    peak=Math.max(peak,v);
    maxdd=Math.min(maxdd, (v-peak)/peak);
  }
  return maxdd;
}

function volatility(returns){
  if(returns.length<2) return 0;
  const m=returns.reduce((a,b)=>a+b,0)/returns.length;
  const v=returns.reduce((a,b)=>a+(b-m)*(b-m),0)/returns.length;
  return Math.sqrt(v);
}

async function run(){
  const data = await load();
  if(!data || !data.length){
    document.getElementById('summary').textContent='尚無資料'; return;
  }
  const windowN = Math.max(50, +document.getElementById('window').value||300);
  const series = data.slice(-windowN).map(d=>d.c);
  const cash0 = +document.getElementById('cash').value;
  const dca = +document.getElementById('dca').value;
  const fee = +document.getElementById('fee').value/100;
  const slip = +document.getElementById('slip').value/100;
  const strategy = document.getElementById('strategy').value;

  let cash=cash0, shares=0; const equity=[]; const tx=[];
  series.forEach((price,i)=>{
    let buy = 0;
    if(strategy==='lump' && i===0) buy = cash;
    if(strategy==='dca' && i%30===0) buy = dca; // every 30 mins
    if(buy>0){
      const cost = buy*(1+fee+slip);
      if(cash>=cost){
        const qty = buy/price;
        shares += qty; cash -= cost;
        tx.push(`第${i+1}分鐘：買入 ${qty.toFixed(3)} 股 @ ${price.toFixed(2)}，費用 ${(cost-buy).toFixed(0)}`);
      }
    }
    equity.push(cash + shares*price);
  });

  draw(equity);
  const total = equity[equity.length-1];
  const invested = cash0 + (strategy==='dca' ? dca*Math.floor(series.length/30+1) : 0);
  const rets = equity.slice(1).map((v,i)=>Math.log(v/equity[i]));
  const vol = volatility(rets);
  const mdd = maxDrawdown(equity);

  document.getElementById('summary').textContent = `期末資產 ${Math.round(total).toLocaleString()} 元（投入 ${Math.round(invested).toLocaleString()} 元）`;
  document.getElementById('metrics').innerHTML = `
    <li>最大回撤：${(mdd*100).toFixed(2)}%</li>
    <li>波動（log return std）：${vol.toFixed(4)}</li>
    <li>樣本點數：${series.length}</li>`;
  document.getElementById('tx').innerHTML = tx.slice(0,20).map(t=>`<li>${t}</li>`).join('');
}

document.getElementById('run').onclick=run;
run();
</script>
